

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Account Explorer</title>
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            background-color: #0a0a0a;
            color: #d0d0d0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
    
        .container {
             background-color: #1a1a1a;
            padding: 30px;
            border-radius: 8px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
            max-width: 1200px;
            margin: 20px auto;
            flex: 1;
            transition: all 0.3s ease-in-out;
        }
         .container:empty {
            display: none;
            padding: 0;
            border: none;
            margin: 0;
        }
    
        h1 {
             text-align: center;
            margin-bottom: 30px;
            color: #e0e0e0;
            text-shadow: 0 0 4px #2b2b2b;
            letter-spacing: 2px;
        }
    
        input[type="text"] {
            width: calc(100% - 20px);
           padding: 12px;
            margin-bottom: 20px;
           border: 1px solid #333;
            border-radius: 6px;
            background-color: #2a2a2a;
            color: #c0c0c0;
            transition: border-color 0.3s;
            font-size: 16px;
            letter-spacing: 1px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            outline: none;
        }
    
        input[type="text"]:focus {
             border-color: #e0e0e0;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.6);
        }
    
        button {
           padding: 12px 25px;
             background-color: #e0e0e0;
            color: #1a1a1a;
             border: none;
            border-radius: 6px;
            cursor: pointer;
             transition: background-color 0.3s, transform 0.1s;
            font-size: 16px;
            letter-spacing: 1px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
    
        button:hover {
             background-color: #f0f0f0;
            transform: scale(1.03);
        }
    
        #error-message {
             color: #ff7e7e;
            margin-top: 20px;
            padding: 12px;
            background-color: #2a2a2a;
             border: 1px solid #333;
            border-radius: 6px;
            font-size: 16px;
            letter-spacing: 1px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
    
        .wallet-info {
            margin-top: 25px;
           background-color: #2a2a2a;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 25px;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.7);
           transition: all 0.3s ease-in-out;
        }
        .wallet-info:empty {
            display: none;
             padding: 0;
            border:none;
            margin: 0;
        }
    
        .wallet-info h2 {
            color: #e0e0e0;
             border-bottom: 1px solid #333;
            padding-bottom: 8px;
            margin-bottom: 15px;
            text-shadow: 0 0 2px #2b2b2b;
            letter-spacing: 1px;
        }
    
        .wallet-info .info-item {
             margin-bottom: 12px;
            display: flex;
            align-items: center;
            font-size: 16px;
             letter-spacing: 1px;
        }
    
         .wallet-info .info-item .label {
             font-weight: bold;
            margin-right: 10px;
            color: #e0e0e0;
             text-shadow: 0 0 1px #2b2b2b;
        }
    
        .token-list {
             margin-top: 30px;
            transition: all 0.3s ease-in-out;
        }
        .token-list:empty {
             display: none;
            padding: 0;
           border:none;
           margin: 0;
        }
    
        .token-list h2 {
             color: #e0e0e0;
            border-bottom: 1px solid #333;
             padding-bottom: 8px;
            margin-bottom: 15px;
            text-shadow: 0 0 2px #2b2b2b;
             letter-spacing: 1px;
        }
    
        .token-item {
            background-color: #333;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #333;
           box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            transition: transform 0.1s;
        }
    
        .token-item:hover {
           transform: scale(1.02);
        }
    
        .token-item .label {
            font-weight: bold;
            margin-right: 10px;
             color: #e0e0e0;
           text-shadow: 0 0 1px #2b2b2b;
            letter-spacing: 1px;
        }
    
        .transaction-list {
            margin-top: 30px;
            overflow-x: auto;
           transition: all 0.3s ease-in-out;
        }
         .transaction-list:empty {
            display: none;
            padding: 0;
            border:none;
             margin: 0;
        }
    
        .transaction-list h2 {
             color: #e0e0e0;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
             margin-bottom: 15px;
            text-shadow: 0 0 2px #2b2b2b;
            letter-spacing: 1px;
        }
    
        .transaction-table {
           width: 100%;
             border-collapse: collapse;
            margin-top: 10px;
            background-color: #333;
            border: 1px solid #333;
             border-radius: 8px;
            overflow-x: auto;
        }
    
        .transaction-table th,
        .transaction-table td {
            padding: 10px;
            border: 1px solid #333;
            text-align: left;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
    
        .transaction-table th {
           background-color: #2a2a2a;
             color: #e0e0e0;
           text-shadow: 0 0 1px #2b2b2b;
        }
    
        .pagination {
             margin-top: 25px;
            text-align: center;
        }
    
        .pagination button {
           margin: 0 5px;
            background-color: #333;
           color: #e0e0e0;
            border: none;
             padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            letter-spacing: 1px;
             box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }
    
        .pagination button:hover {
            background-color: #4d4d4d;
             transform: scale(1.03);
        }
    
         .pagination .active {
           background-color: #e0e0e0;
             color: #1a1a1a;
        }
    
         a {
            color: #e0e0e0;
           text-decoration: none;
             transition: color 0.3s;
        }
    
    
        a:hover {
           color: #f0f0f0;
        }
    
        .sliced {
            display: inline-block;
            max-width: 150px;
           overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    
        .sliced:hover {
             overflow: visible;
            white-space: normal;
            word-break: break-all;
        }
    
        .transaction-hash-container {
            display: flex;
           align-items: center;
            gap: 6px;
        }
    
        .copy-icon {
            cursor: pointer;
            width: 14px;
            height: 14px;
            fill: #e0e0e0;
        }
    
        .copy-icon:hover {
            fill: #f0f0f0;
        }
    
        .transaction-details {
            margin-top: 20px;
            background-color: #333;
            padding: 16px;
            border-radius: 8px;
           border: 1px solid #333;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.7);
             overflow-x: auto;
             margin-bottom: 20px;
            transition: all 0.3s ease-in-out;
        }
        .transaction-details:empty {
            display: none;
            padding: 0;
            border:none;
            margin: 0;
        }
    
        .transaction-details h2 {
             color: #e0e0e0;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
             margin-bottom: 15px;
           text-shadow: 0 0 2px #2b2b2b;
           letter-spacing: 1px;
        }
    
        .transaction-details .info-item {
             margin-bottom: 12px;
            display: flex;
           align-items: center;
            font-size: 16px;
            letter-spacing: 1px;
        }
    
        .transaction-details .info-item .label {
            font-weight: bold;
             margin-right: 10px;
            color: #e0e0e0;
            text-shadow: 0 0 1px #2b2b2b;
        }
        .sol-transfer-section{
            margin-bottom: 20px;
             background-color: #2a2a2a;
           padding: 20px;
            border-radius: 8px;
             box-shadow: 0 3px 6px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
         .token-transfer-section{
           margin-bottom: 20px;
           background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
    
        .limit-select {
            margin-top: 10px;
            text-align: center;
            display: none;
        }
    
        .limit-select button {
            background-color: #333;
            color: #e0e0e0;
            border: none;
           padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 4px;
             box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }
    
        .limit-select button:hover {
             background-color: #4d4d4d;
        }
    
        .limit-select .selected {
            background-color: #e0e0e0;
           color:#1a1a1a;
        }
    
    </style>
</head>

<body>
    <div class="container">
        <h1>Solana Account Explorer</h1>
        <input type="text" id="walletAddress" placeholder="Enter Solana Wallet/Transaction Address (Devnet)">
        <button onclick="fetchAccountDetails()">Get Details</button>
        <div id="error-message"></div>
        <div id="wallet-info" class="wallet-info"></div>
        <div id="token-balances" class="token-list"></div>
        <div id="transaction-history" class="transaction-list"></div>
        <div id="pagination" class="pagination"></div>
         <div id="transaction-details" class="transaction-details"></div>
        <div class="limit-select">
           <button onclick="changeTransactionLimit(40)">40</button>
           <button onclick="changeTransactionLimit(100)" class="selected">100</button>
           <button onclick="changeTransactionLimit('all')">All</button>
       </div>
    </div>
    <script>
          const apiUrl = "https://explorer-api.devnet.solana.com/";
         const explorerApiUrl = "https://explorer.solana.com/tx/";
        const LAMPORTS_PER_SOL = 1000000000;
        let allTransactions = [];
         let currentPage = 1;
         let transactionsPerPage = 100; // Default 100
         let currentTransactionSignature = null;


         document.getElementById('walletAddress').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevents form submission or other default actions
        fetchAccountDetails();
    }
});




           async function fetchAccountDetails(walletAddressFromUrl = null) {
            const walletAddress = walletAddressFromUrl || document.getElementById('walletAddress').value;
            const walletInfoDiv = document.getElementById('wallet-info');
            const errorMessageDiv = document.getElementById('error-message');
             const tokenBalancesDiv = document.getElementById('token-balances');
           const transactionHistoryDiv = document.getElementById('transaction-history');
           const paginationDiv = document.getElementById('pagination');
            const transactionDetailsDiv = document.getElementById('transaction-details');
            const limitSelectDiv = document.querySelector('.limit-select');

           walletInfoDiv.innerHTML = '';
            errorMessageDiv.textContent = '';
            tokenBalancesDiv.innerHTML = '';
             transactionHistoryDiv.innerHTML = '';
           paginationDiv.innerHTML = '';
            transactionDetailsDiv.innerHTML = "";
            limitSelectDiv.style.display = 'none';
            currentTransactionSignature = null;

            if (!walletAddress) {
                 errorMessageDiv.textContent = "Please enter a wallet or transaction address.";
                updateUrl('');
                return;
            }
            const isWalletAddress = /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(walletAddress);
            if (isWalletAddress) {
                try {
                   // Fetch SOL balance and general account info
                    const accountInfo = await fetchAccountInfo(walletAddress);
                    if (accountInfo) {
                         displayWalletInfo(accountInfo, walletAddress);
                         limitSelectDiv.style.display = 'flex';
                   }
                     // Fetch token balances
                    const tokenBalances = await fetchTokenBalances(walletAddress);
                    if (tokenBalances && tokenBalances.length > 0) {
                         displayTokenBalances(tokenBalances);
                    } else {
                        tokenBalancesDiv.innerHTML = `<p>No Tokens held</p>`
                    }
                    // Fetch all transactions
                     allTransactions = await fetchAllTransactions(walletAddress);
                    renderTransactions(walletAddress);
                   updateUrl(walletAddress);
                } catch (error) {
                    errorMessageDiv.textContent = `Error: ${error.message}`;
                }
             } else {
               try {
                   // Handle transaction hash
                    const transactionDetails = await fetchTransactionDetails(walletAddress);
                    if (transactionDetails) {
                         displayTransactionDetails(transactionDetails);
                         updateUrl(walletAddress);
                    } else {
                        errorMessageDiv.textContent = `No transaction found for address: ${walletAddress}`;
                       updateUrl('');
                    }
                 } catch (error) {
                     errorMessageDiv.textContent = `Error: ${error.message}`;
                   updateUrl('');
               }
            }
       }
       async function fetchAccountInfo(walletAddress) {
    const requestBody = {
        "method": "getMultipleAccounts",
        "jsonrpc": "2.0",
        "params": [
            [walletAddress],
            {
                "encoding": "jsonParsed",
                "commitment": "confirmed"
            }
        ],
        "id": "31c08bb3-374c-4a03-9e02-a86250d79ff4"
    };
    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        });
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        if(data.error){
            throw new Error(`RPC Error: ${data.error.message}`);
        }

        if (data.result && data.result.value && data.result.value.length > 0 && data.result.value[0]) {
           return data.result.value[0];
       } else {
            return null;
        }
    } catch (error) {
        console.error("Failed to fetch account info:", error);
        return null;
    }
}


async function displayWalletInfo(accountInfo, walletAddress) {
    const walletInfoDiv = document.getElementById('wallet-info');
    let solBalance = 0;

    if (accountInfo && accountInfo.lamports) {
        solBalance = accountInfo.lamports / 1000000000;
    }


    let lastTransactionTime = "N/A";

    try {
        const transactions = await fetchTransactionHistory(walletAddress);
        if (transactions && transactions.length > 0) {
           const lastTransaction = transactions[0];
           lastTransactionTime = lastTransaction && lastTransaction.blockTime ? new Date(lastTransaction.blockTime * 1000).toLocaleString() : "N/A";

        }
        walletInfoDiv.innerHTML = `
        <h2>Wallet Information</h2>
            <div class="info-item">
                <span class="label">SOL Balance:</span> ${solBalance.toFixed(4)} SOL
            </div>
                <div class="info-item">
                <span class="label">Last Transaction Time:</span> ${lastTransactionTime}
            </div>`;
    } catch(error) {
        walletInfoDiv.innerHTML = `
            <h2>Wallet Information</h2>
            <div class="info-item">
                <span class="label">SOL Balance:</span> ${solBalance.toFixed(4)} SOL
            </div>
            <div class="info-item">
            <span class="label">Last Transaction Time:</span> Error getting last transaction
            </div>`;
    }
}

async function fetchTokenBalances(walletAddress) {
    const requestBody = {
        "method": "getTokenAccountsByOwner",
        "jsonrpc": "2.0",
        "params": [
            walletAddress,
            {
                "programId": "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
            },
            {
                "encoding": "jsonParsed",
                "commitment": "processed"
            }
        ],
        "id": "a0235608-7a3b-4c2b-b2c7-79e5f57200a1" // you can generate a unique ID for each request if needed
    };

    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
         if(data.error){
            throw new Error(`RPC Error: ${data.error.message}`);
        }
        if (data.result && data.result.value) {
            return data.result.value;
        } else {
            return [];
        }

    } catch (error) {
        console.error("Failed to fetch token accounts:", error);
        return [];
    }
}


 async function displayTokenBalances(tokenAccounts) {
    const tokenBalancesDiv = document.getElementById('token-balances');
    tokenBalancesDiv.innerHTML = "";  //Clear previous content
     if (!tokenAccounts || tokenAccounts.length === 0) {
        tokenBalancesDiv.innerHTML = `<p>No Tokens held</p>`;
        return;
    }

    let tokensHTML = `<h2>Token Balances</h2>`;
        for (const accountData of tokenAccounts) {
         const account = accountData.account;

        if (!account || !account.data || !account.data.parsed || !account.data.parsed.info) {
            console.warn("Skipping invalid account data", accountData);
            continue;
        }

        const mint = account.data.parsed.info.mint;
        const amount = account.data.parsed.info.tokenAmount?.uiAmount;
       try {
            const tokenName = await fetchTokenName(mint);
              tokensHTML += `
                <div class="token-item">
                <div class="info-item">
                <span class="label">Name:</span>
                   <a href="/${mint}" onclick="navigateToWallet(event, '${mint}')" title="${mint}" style="display:inline-block; word-break: break-all;">${tokenName}</a>
                 </div>
                      <div class="info-item">
                       <span class="label">Mint:</span>
                           <div class="transaction-hash-container">
                              <a href="/${mint}" onclick="navigateToWallet(event, '${mint}')" title="${mint}" style="display:inline-block; word-break: break-all;">${mint}</a>
                                <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${mint}', this)">
                                  <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                           </div>
                     </div>
                     <div class="info-item">
                       <span class="label">Balance:</span> ${amount}
                     </div>
                </div>`;
        } catch (error) {
              console.error("Failed to fetch token name or display token info", error);
                  tokensHTML += `
                     <div class="token-item">
                         <div class="info-item">
                            <span class="label">Mint:</span> ${mint}
                         </div>
                         <div class="info-item">
                            <span class="label">Balance:</span> ${amount}
                         </div>
                     </div>`;
        }


      }


    tokenBalancesDiv.innerHTML = tokensHTML;

}
async function fetchTokenName(mintAddress) {
    const requestBody = {
        "jsonrpc": "2.0",
        "id": "1",
        "method": "getAsset",
        "params": {
            "id": mintAddress
        }
    };
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        return data?.result?.content?.metadata?.name || mintAddress;
    } catch (error) {
        console.error("Failed to fetch token name:", error);
        return mintAddress;
    }
}


        async function fetchTransactionHistory(walletAddress) {
           const requestBody = {
                jsonrpc: "2.0",
                 id: "609466de-6a04-4d9a-a6e3-63d7c5282d5a",
                method: "getSignaturesForAddress",
                params: [
                   walletAddress,
                   {
                        limit: 5
                   }
                ]
            };
             try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                   headers: {
                         "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(`RPC Error: ${data.error.message}`);
                }
                return data.result;
            } catch (error) {
                console.error("Failed to fetch transaction history:", error);
                return null;
            }
        }
       async function fetchAllTransactions(walletAddress, before = null) {
             let allTransactions = [];
            let hasMore = true;
             let beforeSignature = before;
            while (hasMore) {
               const requestBody = {
                    jsonrpc: "2.0",
                    id: "609466de-6a04-4d9a-a6e3-63d7c5282d5a",
                    method: "getSignaturesForAddress",
                     params: [
                         walletAddress,
                        {
                            limit: 100,
                           before: beforeSignature
                       }
                    ]
                };
               try {
                     const response = await fetch(apiUrl, {
                        method: "POST",
                       headers: {
                           "Content-Type": "application/json"
                        },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const data = await response.json();
                     if (data.error) {
                        throw new Error(`RPC Error: ${data.error.message}`);
                    }
                    const transactionSignatures = data.result;
                     if (!transactionSignatures || transactionSignatures.length === 0) {
                         hasMore = false;
                         continue;
                   }
                    allTransactions = allTransactions.concat(transactionSignatures);
                     beforeSignature = transactionSignatures[transactionSignatures.length - 1].signature;
                } catch (error) {
                    console.error("Failed to fetch all transactions:", error);
                     hasMore = false;
                }
            }
            return allTransactions;
        }
      async function fetchTransactionDetails(signature) {
             const requestBody = {
               jsonrpc: "2.0",
                 id: "3a0229c2-b950-45ce-9b10-694e987b3498",
                method: "getTransaction",
                params: [
                   signature,
                    {
                        "encoding":"jsonParsed",
                        "commitment":"confirmed",
                       "maxSupportedTransactionVersion":0
                   }
               ]
           };
            try {
               const response = await fetch(apiUrl, {
                     method: "POST",
                     headers: {
                         "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestBody)
               });
                 if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                 }
               const data = await response.json();
               if (data.error) {
                    throw new Error(`RPC Error: ${data.error.message}`);
                }
                 return data.result;
           } catch (error) {
                 console.error("Failed to fetch transaction details:", error);
               return null;
           }
        }
        async function displayTransactionDetails(results) {
    const transactionDetailsDiv = document.getElementById('transaction-details');
    transactionDetailsDiv.innerHTML = "";

    if (!results) {
        transactionDetailsDiv.innerHTML = `<p>Invalid transaction data</p>`;
        return;
    }

    const blockTime = results.blockTime ? new Date(results.blockTime * 1000) : null;
    const gasSpent = results.meta.computeUnitsConsumed;
    const fee = results.meta.fee / LAMPORTS_PER_SOL;
    const blockNumber = results.slot;
    const confirmationTime = blockTime ? blockTime.toLocaleString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'UTC',
        timeZoneName: 'short'
    }) : "N/A";

    const timeSinceConfirmationSeconds = Math.floor((Date.now() / 1000) - results.blockTime);
    let timeSinceConfirmation = "";

    if (timeSinceConfirmationSeconds < 60) {
        timeSinceConfirmation = `${timeSinceConfirmationSeconds} seconds ago`;
    } else if (timeSinceConfirmationSeconds < 3600) {
        const minutes = Math.floor(timeSinceConfirmationSeconds / 60);
        timeSinceConfirmation = `${minutes} mins ago`;
    } else if (timeSinceConfirmationSeconds < 86400) {
        const hours = Math.floor(timeSinceConfirmationSeconds / 3600);
        const minutes = Math.floor((timeSinceConfirmationSeconds % 3600) / 60);
        timeSinceConfirmation = `${hours} hours and ${minutes} mins ago`;
    } else {
        const days = Math.floor(timeSinceConfirmationSeconds / 86400);
        const hours = Math.floor((timeSinceConfirmationSeconds % 86400) / 3600);
        timeSinceConfirmation = `${days} days and ${hours} hours ago`;
    }

    let transactionInfoHTML = `<h2>Transaction Details</h2>`;
    let tokenTransfers = [];
    let systemTransfer = null;
    let totalTokensTransferred = 0;
    let firstTokenMint = null;
    let systemSender = 'N/A';
    let systemReceiver = 'N/A';
    let firstSigner = results?.transaction?.message?.accountKeys?.[0]?.pubkey || 'N/A';

    if (results.transaction && results.transaction.message && results.transaction.message.instructions) {
        for (const instruction of results.transaction.message.instructions) {
            if (instruction.parsed && (instruction.parsed.type === "transfer" || instruction.parsed.type === "transferChecked")) {
                let sender = 'N/A';
                let receiver = 'N/A';
                let amount = 'N/A';
                let mint = 'N/A';

                if (instruction.program === "spl-token") {
                    if (instruction.parsed?.type === "transferChecked" && instruction.parsed.info.multisigAuthority) {
                        sender = instruction.parsed.info.multisigAuthority;
                    } else {
                        sender = firstSigner;
                    }
                    mint = instruction.parsed.info.mint || 'N/A';
                    if (instruction.parsed?.type === "transferChecked") {
                        amount = instruction.parsed.info.tokenAmount?.uiAmount || 'N/A';
                        if (amount !== 'N/A') {
                            totalTokensTransferred += parseFloat(amount);
                        }
                    } else {
                        amount = instruction.parsed.info.amount || 'N/A';
                        if (amount !== 'N/A') {
                            totalTokensTransferred += parseInt(amount);
                        }
                    }

                    if (results.meta.preTokenBalances && results.meta.postTokenBalances) {
                        const destinationAccount = instruction.parsed.info.destination;
                        const receiverBalance = results.meta.postTokenBalances.find(bal =>
                            results.transaction.message.accountKeys[bal.accountIndex].pubkey === destinationAccount
                        );

                        if (receiverBalance) {
                            receiver = receiverBalance.owner;
                            mint = receiverBalance.mint;
                        }
                    }

                    tokenTransfers.push({
                        sender: sender,
                        receiver: receiver,
                        amount: amount,
                        mint: mint
                    });
                    if (mint && !firstTokenMint) {
                        firstTokenMint = mint;
                    }
                } else if (instruction.program === "system") {
                    if (instruction.parsed.info.source) {
                        systemSender = instruction.parsed.info.source;
                        sender = instruction.parsed.info.source;
                    }
                    if (instruction.parsed.info.destination) {
                        systemReceiver = instruction.parsed.info.destination;
                        receiver = instruction.parsed.info.destination;
                    }
                    if (results.meta.preBalances && results.meta.postBalances && results.meta.preBalances.length > 0 && results.meta.postBalances.length > 0) {
                         amount = (results.meta.preBalances[0] - results.meta.postBalances[0]) / LAMPORTS_PER_SOL;
                        systemTransfer = {
                            sender: systemSender,
                            receiver: systemReceiver,
                            amount: amount
                        };
                    }
                }
            }
        }
    }
     // Function to fetch token name using the existing API
    const fetchTokenName = async (mintAddress) => {
        const requestBody = {
            "jsonrpc": "2.0",
            "id": "1",
            "method": "getAsset",
            "params": {
                "id": mintAddress
            }
        };
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            return data?.result?.content?.metadata?.name || mintAddress;
        } catch (error) {
            console.error("Failed to fetch token name:", error);
            return mintAddress;
        }
    };
    if (tokenTransfers.length > 0) {
        let firstTokenName = await fetchTokenName(firstTokenMint);
        const formattedTotal = parseFloat(totalTokensTransferred.toFixed(9)).toString();
        transactionInfoHTML += `
            <div class="info-item">
            <span class="label">Total Tokens Transferred:</span> <a href="/${firstTokenMint}" onclick="navigateToWallet(event, '${firstTokenMint}')" title="${firstTokenMint}" style="display:inline-block; word-break: break-all; color:#e0e0e0; text-decoration:none;">${formattedTotal} ${firstTokenName} </a>
            </div>
            <div class="token-transfer-section">
                 <h2>Token Transfers</h2>
                 <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>Token Mint</th>
                            <th>Sender</th>
                            <th>Receiver</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        for (const transfer of tokenTransfers) {
            const tokenName = await fetchTokenName(transfer.mint);
            transactionInfoHTML += `
                    <tr>
                        <td>
                            <div class="transaction-hash-container">
                                <a href="/${transfer.mint}" onclick="navigateToWallet(event, '${transfer.mint}')" title="${transfer.mint}" style="display:inline-block; word-break: break-all;">${tokenName} (${transfer.mint})</a>
                                <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${transfer.mint}', this)">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </div>
                        </td>
                        <td>
                            <div class="transaction-hash-container">
                                <a href="/${transfer.sender}" onclick="navigateToWallet(event, '${transfer.sender}')" title="${transfer.sender}" style="display:inline-block; word-break: break-all;">${transfer.sender}</a>
                                <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${transfer.sender}', this)">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </div>
                        </td>
                        <td>
                             <div class="transaction-hash-container">
                                <a href="/${transfer.receiver}" onclick="navigateToWallet(event, '${transfer.receiver}')" title="${transfer.receiver}" style="display:inline-block; word-break: break-all;">${transfer.receiver}</a>
                                <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${transfer.receiver}', this)">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </div>
                        </td>
                         <td>
                            ${transfer.amount}
                        </td>
                    </tr>
            `;
        }
         transactionInfoHTML += `</tbody></table></div>`;
    }
    if (systemTransfer) {
        transactionInfoHTML += `
            <div class="sol-transfer-section">
                <h2>SOL Transfer</h2>
                 <div class="info-item">
                    <span class="label">Sender Address:</span>
                     <div class="transaction-hash-container">
                        <a href="/${systemTransfer.sender}" onclick="navigateToWallet(event, '${systemTransfer.sender}')" title="${systemTransfer.sender}" style="display:inline-block; word-break: break-all;">${systemTransfer.sender}</a>
                         <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${systemTransfer.sender}', this)">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                    </div>
                </div>
                 <div class="info-item">
                    <span class="label">Receiver Address:</span>
                     <div class="transaction-hash-container">
                        <a href="/${systemTransfer.receiver}" onclick="navigateToWallet(event, '${systemTransfer.receiver}')" title="${systemTransfer.receiver}" style="display:inline-block; word-break: break-all;">${systemTransfer.receiver}</a>
                       <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${systemTransfer.receiver}', this)">
                           <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                     </div>
                 </div>
                 <div class="info-item">
                    <span class="label">Amount (SOL):</span> ${systemTransfer.amount} SOL
                </div>
            </div>
        `;
    }

   transactionInfoHTML += `
        <div class="info-item">
            <span class="label">Block & Timestamp:</span><br>
            <span style="margin-left:20px;">${blockNumber}</span><br>
            <span style="margin-left:20px;">${timeSinceConfirmation}</span><br>
            <span style="margin-left:20px;">${confirmationTime}</span>
        </div>
        <div class="info-item">
            <span class="label">Gas Spent & Fee (SOL):</span> ${gasSpent} | ${fee.toFixed(9)} SOL
        </div>
    `;


    transactionDetailsDiv.innerHTML = transactionInfoHTML;
}

async function renderTransactions(walletAddress) {
    const transactionHistoryDiv = document.getElementById('transaction-history');
    const paginationDiv = document.getElementById('pagination');
    const transactionDetailsDiv = document.getElementById('transaction-details');

    transactionHistoryDiv.innerHTML = '';
    paginationDiv.innerHTML = '';
    transactionDetailsDiv.innerHTML = "";

    if (!allTransactions || allTransactions.length === 0) {
        transactionHistoryDiv.innerHTML = `<p>No Transactions found</p>`;
        return;
    }

    // Create initial table structure
    transactionHistoryDiv.innerHTML = `
        <h2>Transaction History</h2>
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Signature</th>
                    <th>Block Time</th>
                     <th>Status</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody id="transaction-tbody"></tbody>
        </table>`;

    const tbody = document.getElementById('transaction-tbody');

    for (let i = 0; i < allTransactions.length; i++) {
        const transaction = allTransactions[i];
        if (!transaction || !transaction.signature) continue;

        const signature = transaction.signature;
        const blockTime = transaction.blockTime ? new Date(transaction.blockTime * 1000) : null;
        const formattedBlockTime = blockTime ? blockTime.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit',
            timeZone: 'UTC',
            timeZoneName: 'short'
        }) : "Pending";
        const status = transaction.confirmationStatus === 'finalized' ? 'Finalized' : 'Pending';

        // Create row with loading state
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="transaction-hash-container">
                    <a href="/${signature}" onclick="showTransactionDetails(event, '${signature}')" title="${signature}" style="display:inline-block; word-break: break-all;">${signature}</a>
                    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${signature}', this)">
                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                </div>
            </td>
              <td>${formattedBlockTime}</td>
              <td>${status}</td>
            <td>Loading...</td>
            <td>Loading...</td>
            <td>Loading...</td>`;
        tbody.appendChild(row);

        // Fetch and update transaction details asynchronously
        fetchTransactionDetails(signature).then(async transactionDetails => {

             let source = 'N/A';
            let destination = 'N/A';
            let mint = 'N/A';
            let amount = 'N/A';
            let isSolTransfer = false;
            let tokenName = 'N/A';
            let firstSigner = transactionDetails?.transaction?.message?.accountKeys?.[0]?.pubkey || 'N/A';
            if (transactionDetails?.transaction?.message?.instructions) {
                  for (const instruction of transactionDetails.transaction.message.instructions) {
                    if (instruction.parsed?.type === "transfer" || instruction.parsed?.type === "transferChecked") {
                        if(instruction.program === "spl-token"){

                                if (instruction.parsed?.type === "transferChecked" && instruction.parsed.info.multisigAuthority) {
                                    source = instruction.parsed.info.multisigAuthority;
                                 } else {
                                    source = firstSigner;
                                }


                            mint = instruction.parsed.info.mint || 'N/A';
                            if (instruction.parsed?.type === "transferChecked") {
                                amount = instruction.parsed.info.tokenAmount?.uiAmount || 'N/A';
                            } else {
                                amount = instruction.parsed.info.amount || 'N/A';
                            }
                            if (mint !== 'N/A'){
                                tokenName =  await fetchTokenName(mint);
                            }
                            if (transactionDetails.meta.preTokenBalances && transactionDetails.meta.postTokenBalances) {
                                const destinationAccount = instruction.parsed.info.destination;
                                const receiverBalance = transactionDetails.meta.postTokenBalances.find(bal =>
                                transactionDetails.transaction.message.accountKeys[bal.accountIndex].pubkey === destinationAccount
                             );

                                if (receiverBalance) {
                                  destination = receiverBalance.owner;
                                }
                            }

                            break;
                        } else if(instruction.program === "system"){

                             if(instruction.parsed.info.source) {
                                  source = instruction.parsed.info.source;
                            }
                             if(instruction.parsed.info.destination) {
                                   destination = instruction.parsed.info.destination;
                              }

                             if (transactionDetails.meta.preBalances?.[0] && transactionDetails.meta.postBalances?.[0]) {
                                  amount = (transactionDetails.meta.preBalances[0] - transactionDetails.meta.postBalances[0]) / LAMPORTS_PER_SOL;
                                 isSolTransfer = true; // Mark as SOL transfer
                              }
                            break;
                       }

                     }
                }
            }



            // Update row with fetched data
           row.children[3].innerHTML = `
                 <div class="transaction-hash-container">
                     <a href="/${source}" onclick="navigateToWallet(event, '${source}')"  title="${source}" style="display:inline-block; word-break: break-all;">${source}</a>
                       <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${source}', this)">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                         </svg>
                    </div>
                 `;
            row.children[4].innerHTML = `
                <div class="transaction-hash-container">
                    <a href="/${destination}" onclick="navigateToWallet(event, '${destination}')"  title="${destination}" style="display:inline-block; word-break: break-all;">${destination}</a>
                      <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" onclick="copyToClipboard('${destination}', this)">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                       </svg>
                 </div>
            `;


           row.children[5].textContent = isSolTransfer ? `${amount} SOL` : `${amount} ${tokenName}`;


        });
    }

    paginationDiv.innerHTML = "";
}
 async function fetchTokenName(mintAddress) {
        const requestBody = {
            "jsonrpc": "2.0",
            "id": "1",
            "method": "getAsset",
            "params": {
                "id": mintAddress
            }
        };
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
             return data?.result?.content?.metadata?.name || mintAddress;

        } catch (error) {
            console.error("Failed to fetch token name:", error);
           return mintAddress;
        }
    };

        function updateUrl(walletAddress) {
            if (walletAddress) {
               history.pushState(null, null, `/${walletAddress}`);
           } else {
                history.pushState(null, null, '/');
           }
       }
         function navigateToWallet(event, walletAddress) {
            if (event) {
                 event.preventDefault();
            }
           document.getElementById('walletAddress').value = walletAddress;
            fetchAccountDetails(walletAddress);
         }
        function copyToClipboard(text, element) {
             navigator.clipboard.writeText(text).then(() => {
                 element.classList.add('copied');
                setTimeout(() => {
                    element.classList.remove('copied');
                }, 1500)
            });
        }
         // On page load, parse wallet address from URL
        window.onload = function () {
            const path = window.location.pathname;
             if (path && path.length > 1) {
               const walletAddressFromUrl = path.substring(1);
               document.getElementById('walletAddress').value = walletAddressFromUrl;
                fetchAccountDetails(walletAddressFromUrl);
           }
        }
        async function showTransactionDetails(event, signature) {
             event.preventDefault();
            document.getElementById('walletAddress').value = signature;
            fetchAccountDetails(signature);
        }
    </script>
</body>
</html>
